<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>20m-SRT - Landscape 5 Cols</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 
    <script>
        window.isPdfLibLoaded = typeof window.jspdf !== 'undefined';
    </script>

    <style>
        :root {
            --bg-color: #f4f6f8;
            --container-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent-color: #3498db; 
            --highlight-color: #e67e22; 
            --timer-color: #27ae60; 
            --countdown-color: #e74c3c; 
            --pause-color: #f39c12; 
            --speed-color: #9b59b6; 
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --font-main: 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 98%; /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
            max-width: 1600px;
            text-align: center;
        }

        /* Header Area */
        .header-area {
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: var(--accent-color);
        }

        .audio-status-bar {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: inline-block;
        }
        .audio-status-bar.ready { background-color: #d4edda; color: #155724; }
        .audio-status-bar.error { background-color: #f8d7da; color: #721c24; }

        /* --- 5 Column Grid Layout --- */
        .main-layout {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* ‡πÅ‡∏ö‡πà‡∏á 5 ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
            gap: 15px;
            align-items: start;
        }

        /* Column Styles */
        .layout-col {
            background: #fff;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #eee;
            min-height: 400px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
            display: flex;
            flex-direction: column;
        }

        .col-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--text-sub);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
            text-transform: uppercase;
        }

        /* Col 1: Stats */
        .stats-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .stat-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 8px;
        }
        .stat-label { font-size: 11px; color: var(--text-sub); text-transform: uppercase; font-weight: 600; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--text-main); }
        #cum-stat-box { background-color: var(--highlight-color); color: white; border: none; }
        #cum-stat-box .stat-label { color: white; }
        #cum-display { color: white; font-size: 36px; }

        /* Col 2: Timer */
        .next-beep-box {
            background-color: #fff3cd; border: 1px solid #ffeeba;
            padding: 20px 10px; border-radius: 12px; margin-bottom: 20px;
        }
        #countdown-display { color: var(--countdown-color); font-size: 48px; font-weight: bold; }
        
        .timer-display { font-size: 18px; color: var(--text-sub); margin-bottom: 15px; }
        #total-time { color: var(--timer-color); font-size: 28px; font-weight: bold; display: block; }
        
        .progress-bar { width: 100%; height: 15px; background-color: #e9ecef; border-radius: 8px; overflow: hidden; margin-top: auto; }
        .progress-fill { height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.1s linear; }

        /* Col 3: Controls */
        .status-text {
            font-size: 24px; font-weight: 700; color: var(--text-main);
            min-height: 40px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center;
        }
        .button-group { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        button.action-btn {
            width: 100%; padding: 15px; font-size: 16px; font-weight: 600;
            border: none; border-radius: 10px; cursor: pointer; color: white;
            background-color: var(--accent-color); box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        button.action-btn:active { transform: scale(0.98); }
        .score-info-box {
            margin-top: 20px; padding: 10px; background-color: #edf7ed;
            border: 1px solid #c8e6c9; border-radius: 8px; color: #1e4620; font-size: 14px;
        }

        /* Col 4: Inputs */
        .runner-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß */
            gap: 8px;
            overflow-y: auto;
        }
        .runner-score-btn {
            background-color: #34495e; color: white; border: none;
            padding: 15px 5px; font-size: 14px; border-radius: 8px; cursor: pointer;
        }
        .runner-score-btn.recorded { background-color: var(--timer-color); font-weight: bold; border: 2px solid #1e8449; }
        .runner-score-btn:hover { opacity: 0.9; }

        /* Col 5: Results */
        .results-container {
            flex-grow: 1; overflow-y: auto; max-height: 500px;
            background-color: #f8f9fa; border-radius: 8px; padding: 10px;
        }
        .results-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .results-list li {
            padding: 8px; border-bottom: 1px solid #eee; font-size: 13px;
        }
        .runner-id { font-weight: bold; color: var(--accent-color); display: inline-block; width: 30px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px; font-weight: bold; }
        .modal-cancel-btn { background: #eee; } .modal-confirm-btn { background: #e74c3c; color: white; }

        /* Responsive: Stack on Tablet/Mobile */
        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: repeat(3, 1fr); }
            /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            .col-results { grid-column: 1 / -1; }
        }
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
        }

        /* Print Style */
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; width: 100%; max-width: 100%; }
            .header-area, .layout-col, .button-group { display: none !important; }
            /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏≠‡∏ô‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏ó‡πå‡πÅ‡∏ö‡∏ö Native */
            .col-results { display: block !important; border: none; }
            .results-container { max-height: none; overflow: visible; background: white; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-area">
            <h1>20m-SRT (Landscape View)</h1>
            <div id="audio-status" class="audio-status-bar">
                <span>üîå Waiting for Audio...</span>
            </div>
        </div>

        <div class="main-layout">
            
            <div class="layout-col col-stats">
                <div class="col-title">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
                <div class="stats-vertical">
                    <div class="stat-box" id="cum-stat-box">
                        <div class="stat-label">‡∏£‡∏ß‡∏°‡∏£‡∏≠‡∏ö (Laps)</div>
                        <div class="stat-value" id="cum-display">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Level</div>
                        <div class="stat-value" id="level-display">1</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Shuttle</div>
                        <div class="stat-value" id="shuttle-display">1</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Speed (km/h)</div>
                        <div class="stat-value" id="speed-display">8.5</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Distance (m)</div>
                        <div class="stat-value" id="dist-display">0</div>
                    </div>
                </div>
            </div>

            <div class="layout-col col-timer">
                <div class="col-title">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤</div>
                <div class="next-beep-box">
                    <div class="stat-label" style="color: #856404; margin-bottom: 5px;">Next Beep In</div>
                    <div id="countdown-display">0.00</div>
                </div>
                <div class="timer-display">
                    <div>Total Time:</div>
                    <span id="total-time">00:00</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>

            <div class="layout-col col-controls">
                <div class="col-title">üéÆ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</div>
                <div class="status-text" id="status-text">Ready</div>
                
                <div class="button-group">
                    <button id="start-btn" class="action-btn" onclick="startTest()">‚ñ∂ START (Space)</button>
                    <button id="pause-btn" class="action-btn" onclick="togglePause()" style="display: none; background-color: var(--pause-color);">‚è∏ PAUSE (Space)</button>
                    <button id="pdf-export-btn" class="action-btn" onclick="handleExport()" style="display: none; background-color: #2c3e50;">‚¨á PDF / Print (S)</button>
                </div>

                <div class="score-info-box">
                    <strong>Current Pace:</strong><br>
                    <span id="score-text">Lvl 1 - Lap 0</span>
                </div>
            </div>

            <div class="layout-col col-inputs">
                <div class="col-title">üèÉ ‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö (1-10)</div>
                <div id="runner-buttons" class="runner-grid">
                    </div>
                <div style="font-size: 11px; color: #999; margin-top: 10px; text-align: center;">
                    ‡∏Å‡∏î 0 ‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà 10
                </div>
            </div>

            <div class="layout-col col-results">
                <div class="col-title">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</div>
                <div class="results-container">
                    <ul id="saved-results-list" class="results-list">
                        <li style="text-align:center; color:#999;">- ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="custom-modal">
        <div class="modal-content">
            <div id="modal-title" style="font-weight: bold; margin-bottom: 10px; font-size: 18px;">‚ÑπÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
            <div id="modal-body" style="margin-bottom: 20px;"></div>
            <input type="password" id="modal-input" style="display:none; width: 100%; padding: 8px; margin-bottom: 10px;" placeholder="Password">
            <div id="modal-actions" style="display:flex; justify-content: flex-end;"></div>
        </div>
    </div>

    <script>
        // === Audio & Logic (Same as before) ===
        let audioCtx = null;
        const statusDiv = document.getElementById('audio-status');

        function updateAudioStatus(msg, type) {
            statusDiv.innerHTML = msg;
            statusDiv.className = 'audio-status-bar ' + type;
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                audioCtx.onstatechange = () => {
                    if (audioCtx.state === 'running') updateAudioStatus("üîä Audio Ready", "ready");
                    else updateAudioStatus("üîá Suspended", "error");
                };
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            updateAudioStatus("üîä Audio Ready", "ready");
        }

        function playTone(duration = 0.7, freq = 500) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine'; osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(1.0, audioCtx.currentTime + 0.05); 
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration - 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        // TTS
        let thaiVoice = null;
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                 const voices = speechSynthesis.getVoices();
                 thaiVoice = voices.find(v => v.lang === 'th-TH') || null;
            };
        }
        function speak(text) {
             if (!('speechSynthesis' in window)) return;
             speechSynthesis.cancel(); 
             const u = new SpeechSynthesisUtterance(text);
             u.lang = 'th-TH'; u.rate = 1.0; u.pitch = 1.2;
             if (thaiVoice) u.voice = thaiVoice;
             speechSynthesis.speak(u);
        }

        // Logic Variables
        let testSets = { total: 1, current: 1, data: {} };
        let currentLevelIndex = 0, currentShuttleCount = 0, totalCumulativeLaps = 0;
        let isRunning = false, isPaused = false;
        let startTime = 0, timerInterval, shuttleStartTime = 0, shuttleDuration = 0, pauseStartTimestamp = 0;

        const pacerData = [
            { level: 1,  shuttles: 7,  seconds: 8.47, speed: 8.5, cumulative: 7 },
            { level: 2,  shuttles: 8,  seconds: 8.00, speed: 9.0, cumulative: 15 },
            { level: 3,  shuttles: 8,  seconds: 7.58, speed: 9.5, cumulative: 23 },
            { level: 4,  shuttles: 8,  seconds: 7.20, speed: 10.0, cumulative: 31 },
            { level: 5,  shuttles: 9,  seconds: 6.86, speed: 10.5, cumulative: 40 },
            { level: 6,  shuttles: 9,  seconds: 6.55, speed: 11.0, cumulative: 49 },
            { level: 7,  shuttles: 10, seconds: 6.26, speed: 11.5, cumulative: 59 },
            { level: 8,  shuttles: 10, seconds: 6.00, speed: 12.0, cumulative: 69 },
            { level: 9,  shuttles: 10, seconds: 5.76, speed: 12.5, cumulative: 79 },
            { level: 10, shuttles: 11, seconds: 5.54, speed: 13.0, cumulative: 90 },
            { level: 11, shuttles: 11, seconds: 5.33, speed: 13.5, cumulative: 101 },
            { level: 12, shuttles: 12, seconds: 5.14, speed: 14.0, cumulative: 113 },
            { level: 13, shuttles: 12, seconds: 4.97, speed: 14.5, cumulative: 125 },
            { level: 14, shuttles: 13, seconds: 4.80, speed: 15.0, cumulative: 138 },
            { level: 15, shuttles: 13, seconds: 4.65, speed: 15.5, cumulative: 151 },
            { level: 16, shuttles: 13, seconds: 4.50, speed: 16.0, cumulative: 164 },
            { level: 17, shuttles: 14, seconds: 4.36, speed: 16.5, cumulative: 178 },
            { level: 18, shuttles: 14, seconds: 4.24, speed: 17.0, cumulative: 192 },
            { level: 19, shuttles: 15, seconds: 4.11, speed: 17.5, cumulative: 207 },
            { level: 20, shuttles: 15, seconds: 4.00, speed: 18.0, cumulative: 222 },
            { level: 21, shuttles: 15, seconds: 3.89, speed: 18.5, cumulative: 237 }
        ];

        // UI Helpers
        function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }
        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerText = message;
            document.getElementById('modal-actions').innerHTML = `<button class="modal-btn modal-cancel-btn" onclick="closeModal()">OK</button>`;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        // Core Functions
        function startTest() {
            if (isRunning) return;
            initAudio();
            let countdown = 6;
            document.getElementById('status-text').innerText = `Starting...`;
            document.getElementById('start-btn').style.display = 'none';
            
            const preInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('status-text').innerText = `In ${countdown}...`;
                    if (countdown <= 5) speak(["", "‡∏´‡∏ô‡∏∂‡πà‡∏á", "‡∏™‡∏≠‡∏á", "‡∏™‡∏≤‡∏°", "‡∏™‡∏µ‡πà", "‡∏´‡πâ‡∏≤"][countdown]);
                } else {
                    clearInterval(preInterval);
                    document.getElementById('status-text').innerText = "RUN!";
                    playTone(1.0, 500); 
                    beginPacerLogic();
                }
            }, 1000);
        }

        function beginPacerLogic() {
            isRunning = true; isPaused = false;
            startTime = Date.now();
            currentLevelIndex = 0; currentShuttleCount = 0; totalCumulativeLaps = 0;
            toggleButtonsState(); startShuttle(); startInterval();
        }

        function startShuttle() {
            const data = pacerData[currentLevelIndex];
            shuttleDuration = data.seconds;
            shuttleStartTime = Date.now();
            updateDisplay();
        }

        function startInterval() {
            timerInterval = setInterval(() => {
                if (isPaused) return;
                const now = Date.now();
                const elapsed = (now - shuttleStartTime) / 1000;
                let remaining = Math.max(0, shuttleDuration - elapsed);

                document.getElementById('total-time').innerText = formatTime(now - startTime);
                document.getElementById('countdown-display').innerText = remaining.toFixed(2);
                document.getElementById('progress-fill').style.width = `${(elapsed / shuttleDuration) * 100}%`;

                if (remaining <= 0.05) nextShuttle();
            }, 20); 
        }

        function nextShuttle() {
            totalCumulativeLaps++;
            const data = pacerData[currentLevelIndex];
            currentShuttleCount++;
            if (currentShuttleCount > data.shuttles) {
                currentLevelIndex++; currentShuttleCount = 1; 
                if (currentLevelIndex >= pacerData.length) { finishTest(); return; }
            }
            playTone(); startShuttle();
        }

        function updateDisplay() {
            const data = pacerData[currentLevelIndex];
            document.getElementById('level-display').innerText = data.level;
            document.getElementById('shuttle-display').innerText = currentShuttleCount; 
            document.getElementById('speed-display').innerText = data.speed.toFixed(1);
            document.getElementById('cum-display').innerText = totalCumulativeLaps;
            document.getElementById('dist-display').innerText = (totalCumulativeLaps * 20).toLocaleString();
            
            const mrs = getMaxSpeed(totalCumulativeLaps);
            const scoreStr = getFormattedScore(totalCumulativeLaps);
            document.getElementById('score-text').innerText = `${scoreStr}`;
        }

        function formatTime(ms) {
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
        }

        function togglePause() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseStartTimestamp = Date.now();
                document.getElementById('status-text').innerText = "PAUSED";
                document.getElementById('pause-btn').innerText = "RESUME";
                document.getElementById('pause-btn').style.backgroundColor = '#27ae60';
            } else {
                const diff = Date.now() - pauseStartTimestamp;
                startTime += diff; shuttleStartTime += diff;
                document.getElementById('status-text').innerText = "RUN!";
                document.getElementById('pause-btn').innerText = "PAUSE";
                document.getElementById('pause-btn').style.backgroundColor = 'var(--pause-color)';
            }
        }

        function finishTest() {
            clearInterval(timerInterval);
            isRunning = false;
            playTone(0.5, 500); playTone(0.5, 500);
            document.getElementById('status-text').innerText = "FINISHED";
            document.getElementById('start-btn').innerText = "START NEW";
            toggleButtonsState();
        }

        function saveRunnerScore(id) {
            if (totalCumulativeLaps === 0 && !isRunning) { showModal('‚ö†Ô∏è', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'); return; }
            const key = `${testSets.current}-${id}`;
            if (testSets.data[key]) delete testSets.data[key];
            else {
                testSets.data[key] = {
                    runnerId: id, set: testSets.current, score: totalCumulativeLaps,
                    levelLap: getFormattedScore(totalCumulativeLaps),
                    distance: totalCumulativeLaps * 20,
                    time: document.getElementById('total-time').innerText,
                    maxSpeed: getMaxSpeed(totalCumulativeLaps).toFixed(1),
                    timestamp: Date.now() 
                };
            }
            renderRunnerScores();
        }

        function getMaxSpeed(laps) {
            if (laps <= 0) return 0.0;
            let speed = pacerData[0].speed;
            for(let d of pacerData) {
                if(laps >= d.cumulative) speed = d.speed; else break;
            }
            return speed;
        }

        function getFormattedScore(laps) {
            if (laps <= 0) return "Lvl 1 - Lap 0";
            for(let i=pacerData.length-1; i>=0; i--) {
                const prevCum = i>0 ? pacerData[i-1].cumulative : 0;
                if(laps > prevCum) return `Lvl ${pacerData[i].level} - Lap ${laps - prevCum}`;
            }
            return "Lvl 1 - Lap 1";
        }

        function renderRunnerScores() {
            const list = document.getElementById('saved-results-list');
            list.innerHTML = '';
            let items = Object.values(testSets.data).sort((a,b) => a.timestamp - b.timestamp);

            if (items.length === 0) list.innerHTML = '<li style="text-align:center; color:#999;">- ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -</li>';
            else {
                items.forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="runner-id">#${s.runnerId}</span> ${s.levelLap} (${s.score} ‡∏£‡∏≠‡∏ö)`;
                    list.appendChild(li);
                });
            }
            setupRunnerButtons();
            toggleButtonsState();
        }

        function setupRunnerButtons() {
            const grid = document.getElementById('runner-buttons');
            grid.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'runner-score-btn';
                if (testSets.data[`${testSets.current}-${i}`]) {
                    btn.classList.add('recorded');
                    btn.innerText = `#${i} ‚úÖ`;
                } else {
                    btn.innerText = `#${i}`;
                }
                btn.onclick = () => saveRunnerScore(i);
                grid.appendChild(btn);
            }
        }

        function toggleButtonsState() {
            const hasData = Object.keys(testSets.data).length > 0;
            document.getElementById('start-btn').style.display = isRunning || isPaused ? 'none' : 'inline-block';
            document.getElementById('pause-btn').style.display = isRunning || isPaused ? 'inline-block' : 'none';
            document.getElementById('pdf-export-btn').style.display = hasData ? 'inline-block' : 'none';
        }

        function handleExport() {
            if (typeof window.jspdf === 'undefined') window.print();
            else exportToPDF();
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateObj = new Date();
            const ts = `${String(dateObj.getDate()).padStart(2,'0')}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${dateObj.getFullYear()} ${String(dateObj.getHours()).padStart(2,'0')}:${String(dateObj.getMinutes()).padStart(2,'0')}`;
            const fileTs = `${String(dateObj.getDate()).padStart(2,'0')}${String(dateObj.getMonth()+1).padStart(2,'0')}${dateObj.getFullYear()}_${String(dateObj.getHours()).padStart(2,'0')}${String(dateObj.getMinutes()).padStart(2,'0')}`;
            
            doc.setFont("Helvetica", "bold");
            doc.text("20m-SRT Test Results", 14, 20);
            doc.setFont("Helvetica", "normal"); doc.setFontSize(10);
            doc.text(`Date: ${ts}`, 14, 26);
            
            let yPos = 35;
            let items = Object.values(testSets.data).sort((a,b) => a.timestamp - b.timestamp);

            if(items.length === 0) { showModal('‚ö†Ô∏è', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }

            items.forEach(s => {
                if (yPos > 280) { doc.addPage(); yPos = 20; }
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° ${s.distance}m ‡πÉ‡∏ô PDF ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                doc.text(`Runner #${s.runnerId}: ${s.levelLap} (${s.score} laps - ${s.distance} m) - MRS: ${s.maxSpeed} km/h - Time: ${s.time}`, 14, yPos);
                yPos += 7;
            });
            doc.save(`PACER_Result_${fileTs}.pdf`);
        }
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('custom-modal').style.display === 'flex') return;
            if (event.code === 'Space') {
                event.preventDefault();
                if (!isRunning && !isPaused && document.getElementById('start-btn').style.display !== 'none') startTest();
                else if (isRunning || isPaused) togglePause();
            }
            if (event.key >= '1' && event.key <= '9') saveRunnerScore(parseInt(event.key));
            else if (event.key === '0') saveRunnerScore(10);
            if (event.key.toLowerCase() === 's' && document.getElementById('pdf-export-btn').style.display !== 'none') handleExport();
        });

        window.addEventListener('beforeunload', (e) => { if (isRunning) { e.preventDefault(); e.returnValue = ''; } });
        window.onload = () => { setupRunnerButtons(); };
    </script>
</body>
</html>
