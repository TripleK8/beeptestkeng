<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACER Test Timer (Offline)</title>
    
    <!-- 
        [‡πÇ‡∏´‡∏°‡∏î Offline]
        ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö jsPDF ‡πÅ‡∏ö‡∏ö Local
    -->
    <script src="jspdf.umd.min.js"></script> 
    <script>
        // Fallback for jsPDF
        if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
            document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>');
        }
    </script>

    <style>
        :root {
            --bg-color: #f4f6f8;
            --container-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent-color: #3498db; 
            --highlight-color: #e67e22; 
            --timer-color: #27ae60; 
            --countdown-color: #e74c3c; 
            --pause-color: #f39c12; 
            --speed-color: #9b59b6; 
            --ai-color: #8e44ad; 
            --pilot-color: #16a085; /* ‡∏™‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Pilot */
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --font-main: 'Prompt', 'Sarabun', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            text-align: center;
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        .settings-group {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .toggle-btn {
            background: #ecf0f1;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            color: var(--text-main);
            font-size: 14px;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }
        .toggle-btn:hover {
            background: #dcdcdc;
        }
        
        h1 {
            margin-bottom: 30px;
            margin-top: 40px;
            font-size: 28px;
            color: var(--accent-color);
            font-weight: 700;
        }
        
        .set-input-group {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 12px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .set-control-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .set-input-group input {
            width: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--accent-color);
        }

        .set-navigator {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 8px;
            padding: 5px;
            border: 1px solid #ccc;
        }

        .set-nav-btn {
            background-color: #ecf0f1;
            border: none;
            color: var(--text-main);
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .set-nav-btn:hover {
            background-color: #bdc3c7;
        }
        .set-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .current-set-text {
            font-size: 20px;
            font-weight: bold;
            color: var(--highlight-color);
            margin: 0 15px;
            min-width: 20px;
        }

        .display-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 600px) {
            .display-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .stat-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-main);
        }

        #cum-display { color: var(--highlight-color); }
        #dist-display { color: var(--accent-color); }
        #speed-display { color: var(--speed-color); }

        .timer-display {
            font-size: 20px;
            color: var(--text-sub);
            margin-top: 15px;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }
        
        #total-time {
            color: var(--timer-color);
            font-weight: 700;
            font-size: 24px;
        }
        
        .score-display {
            background-color: #edf7ed;
            color: #1e4620;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 600;
            border: 1px solid #c8e6c9;
            line-height: 1.5;
        }
        
        #score-text {
            color: #2e7d32;
            font-weight: 700;
            font-size: 20px;
            display: block;
            margin-top: 5px;
        }
        
        .score-buttons-container {
            margin-top: 30px;
            padding: 15px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            background-color: #fcfcfc;
            border-radius: 10px;
        }

        .score-label-btn {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .runner-buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        @media (min-width: 600px) {
            .runner-buttons-grid {
                grid-template-columns: repeat(10, 1fr);
            }
        }
        
        .runner-score-btn {
            background-color: #34495e;
            color: white;
            border: none;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            line-height: 1;
        }
        .runner-score-btn:hover {
            background-color: #2c3e50;
            transform: none; 
        }
        .runner-score-btn:active {
            transform: scale(0.98); 
        }
        .runner-score-btn.recorded {
            background-color: var(--timer-color);
            color: white;
            font-weight: bold;
        }

        .saved-results-container {
            margin-top: 30px;
            text-align: left;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 12px;
        }

        .results-title {
            font-size: 20px;
            color: var(--highlight-color);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--highlight-color);
            padding-bottom: 5px;
            font-weight: 700;
        }

        .results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .results-list li {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 16px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .results-list li:last-child {
            border-bottom: none;
        }
        .runner-id {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 2px;
        }
        .runner-score-detail {
            color: #555;
            font-size: 14px;
            line-height: 1.4;
        }

        /* FIX: ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° Control Line 2 ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
            align-items: center;
            /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡πà‡∏≤‡∏á */
            width: 100%;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢‡πÅ‡∏•‡∏∞ Checkbox */
        .control-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            width: 100%; /* ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢ */
            margin-top: 10px;
        }

        button.action-btn {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            padding: 18px 40px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            font-family: inherit;
            min-width: 180px;
        }

        button.action-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        button.action-btn:active {
            transform: scale(0.98);
        }
        
        button.action-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ‡∏õ‡∏∏‡πà‡∏° End Set */
        button.end-set-btn {
            background-color: #8e44ad;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }
        
        /* ‡∏õ‡∏∏‡πà‡∏° Pilot Test (Restore) */
        button.pilot-btn {
            background-color: var(--pilot-color);
            box-shadow: 0 4px 15px rgba(22, 160, 133, 0.3);
            font-size: 16px;
            padding: 12px 25px;
            min-width: auto;
        }

        /* Checkbox Styling (Moved to Control Row) */
        .export-options {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            user-select: none;
        }
        
        .checkbox-wrapper input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            margin-top: 25px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        .status-text {
            margin-top: 20px;
            font-size: 22px;
            color: var(--text-main);
            font-weight: 600;
            height: 30px;
        }

        .next-beep-box {
            background-color: #fff3cd; /* Light yellow bg for alert */
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        #countdown-display {
            color: var(--countdown-color);
            font-size: 36px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #e67e22; /* Warning/Info color */
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .modal-body {
            line-height: 1.6;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 10px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }

        .modal-confirm-btn {
            background-color: #e74c3c;
            color: white;
        }

        .modal-confirm-btn:hover {
            background-color: #c0392b;
        }

        .modal-cancel-btn {
            background-color: #ecf0f1;
            color: var(--text-main);
        }

        .modal-cancel-btn:hover {
            background-color: #bdc3c7;
        }
        /* End Modal Styles */
    </style>
</head>
<body>

    <div class="container">
        <div class="settings-group">
            <button class="toggle-btn" id="font-btn" onclick="toggleFont()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå: Default</button>
        </div>

        <h1>PACER Test Timer (Offline)</h1>
        
        <div class="set-input-group">
            <div class="set-control-item">
                <label for="totalSets">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</label>
                <input type="number" id="totalSets" value="1" min="1" onchange="updateTotalSets(this.value); toggleButtonsState();" oninput="toggleButtonsState()">
            </div>
            <div class="set-control-item">
                <label>‡∏ä‡∏∏‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
                <div class="set-navigator">
                    <button class="set-nav-btn" id="prev-set-btn" onclick="changeSet(-1)">&#9664;</button>
                    <span id="currentSetDisplay" class="current-set-text">1</span>
                    <button class="set-nav-btn" id="next-set-btn-nav" onclick="changeSet(1)">&#9654;</button>
                </div>
            </div>
        </div>

        <div class="display-grid">
            <div class="stat-box">
                <div class="stat-label">Level</div>
                <div class="stat-value" id="level-display">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Laps</div>
                <div class="stat-value" id="shuttle-display">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Speed</div>
                <div class="stat-value" id="speed-display">8.5</div>
                <div class="stat-label" style="font-size: 10px; margin-top: -5px;">km/h</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Cum. Laps</div>
                <div class="stat-value" id="cum-display">0</div> 
            </div>
            <div class="stat-box">
                <div class="stat-label">Distance (m)</div>
                <div class="stat-value" id="dist-display">0</div>
            </div>
        </div>

        <div class="next-beep-box">
             <div class="stat-label" style="color: #856404;">Next Beep In (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</div>
             <div class="stat-value" id="countdown-display">0.00</div>
        </div>

        <div class="timer-display">Total Time: <span id="total-time">00:00</span></div>
        
        <div class="score-display">
            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• (Score): <span id="score-text">Level 1 - Lap 0 | ‡∏£‡∏ß‡∏° 0 ‡∏£‡∏≠‡∏ö | 0 ‡∏°.</span>
        </div>
        
        <div class="status-text" id="status-text">Ready to Start</div>
        
        <div class="score-buttons-container">
            <div class="score-label-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö: (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
            <div id="runner-buttons" class="runner-buttons-grid">
                <!-- Buttons 1-10 -->
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <!-- NEW: Checkbox Row -->
        <div class="control-row">
             <div class="export-options" id="export-options-container" style="display: none;">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="exportAllSets" checked>
                    ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏ó‡∏∏‡∏Å‡∏ä‡∏∏‡∏î‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                </label>
            </div>
        </div>
        
        <!-- Updated Button Group -->
        <div class="button-group">
            <button id="start-btn" class="action-btn" onclick="startTest()">START TEST</button>
            <button id="pause-btn" class="action-btn" onclick="togglePause()" style="display: none; background-color: var(--pause-color); box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);">PAUSE</button>
            
            <button id="next-set-btn" class="action-btn end-set-btn" onclick="finishTestAndAdvance()" style="display: none;">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ (Manual)</button>

            <button id="reset-btn" class="action-btn" onclick="resetTest()" style="display: none; background-color: #e74c3c; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">RESET ALL</button>
            
            <!-- PDF Export Button -->
            <button id="pdf-export-btn" class="action-btn" onclick="exportToPDF()" style="display: none;">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>
            
            <!-- Pilot Data Button (Visible by default, hidden when running) -->
            <button id="pilot-btn" class="action-btn pilot-btn" onclick="generatePilotData()">üß™ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (Pilot Data)</button>
        </div>
        
        <div class="saved-results-container">
            <h2 class="results-title">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</h2>
            <ul id="saved-results-list" class="results-list">
                <li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</li>
            </ul>
        </div>
    </div>

    <!-- Info/Password Modal -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">‚ÑπÔ∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                <p id="modal-text">Content</p>
                <!-- Dynamic input for password -->
                <input type="password" id="modal-input" class="modal-input" placeholder="Admin Password (1234)" style="display:none;">
            </div>
            <div id="modal-actions" class="modal-actions">
                <!-- Dynamic buttons -->
            </div>
        </div>
    </div>

    <script>
        // === State Management ===
        let currentFont = 'Prompt';
        let testSets = {
            total: 1, 
            current: 1, 
            data: {} 
        };
        let currentLevelIndex = 0;
        let currentShuttleCount = 0;
        let totalCumulativeLaps = 0; 
        
        let isRunning = false;
        let isPaused = false;
        let startTime = 0;
        let timerInterval;
        let shuttleStartTime = 0;
        let shuttleDuration = 0;
        let pauseStartTimestamp = 0;
        let audioCtx = null;
        const ADMIN_PASSWORD = "1234";


        function initAudio() {
             if (!audioCtx) {
                 audioCtx = new (window.AudioContext || window.webkitAudioContext)();
             }
        }

        let thaiVoice = null;
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                 const voices = speechSynthesis.getVoices();
                 thaiVoice = voices.find(v => v.lang === 'th-TH') || null;
            };
        }

        function toggleFont() {
            const body = document.body;
            const btn = document.getElementById('font-btn');
            // Check if current font includes 'Prompt' or is unset (which defaults to 'Prompt' via CSS)
            if (body.style.fontFamily && body.style.fontFamily.includes('sans-serif') && !body.style.fontFamily.includes('Prompt')) {
                body.style.fontFamily = `'Prompt', 'Sarabun', sans-serif`;
                btn.innerText = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå: Prompt';
                currentFont = 'Prompt';
            } else {
                body.style.fontFamily = `sans-serif`; // Revert to generic sans-serif
                btn.innerText = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå: Default';
                currentFont = 'Default';
            }
        }

        // --- Custom Modal Functions ---
        function closeModal() {
            document.getElementById('custom-modal').style.display = 'none';
            document.getElementById('modal-input').style.display = 'none'; // Hide input on close
            document.getElementById('modal-input').value = ''; // Clear input
        }

        function showModal(title, message, isError = false) {
            document.getElementById('modal-title').innerHTML = title;
            document.getElementById('modal-title').style.color = isError ? '#e74c3c' : '#e67e22';
            document.getElementById('modal-text').innerText = message;
            document.getElementById('modal-input').style.display = 'none';
            document.getElementById('modal-actions').innerHTML = `
                <button class="modal-btn modal-cancel-btn" onclick="closeModal()">OK</button>
            `;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        function showPasswordModal(onConfirmCallback) {
            document.getElementById('modal-title').innerHTML = 'üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•';
            document.getElementById('modal-title').style.color = '#e74c3c';
            document.getElementById('modal-text').innerText = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (1234):';
            
            const inputField = document.getElementById('modal-input');
            inputField.style.display = 'block';
            inputField.value = '';
            
            document.getElementById('modal-actions').innerHTML = `
                <button class="modal-btn modal-cancel-btn" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="modal-btn modal-confirm-btn" id="modal-confirm-action">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            `;
            
            document.getElementById('custom-modal').style.display = 'flex';
            inputField.focus();

            // Setup the confirmation handler dynamically
            const confirmBtn = document.getElementById('modal-confirm-action');
            confirmBtn.onclick = () => {
                const password = inputField.value;
                if (password === ADMIN_PASSWORD) {
                    closeModal();
                    onConfirmCallback();
                } else {
                    showModal('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á.', true);
                }
            };
        }
        // --- End Custom Modal Functions ---

        function updateTotalSets(value) {
            const total = parseInt(value);
            if (total >= 1) {
                testSets.total = total;
                if (testSets.current > total) {
                    testSets.current = total;
                    document.getElementById('currentSetDisplay').innerText = testSets.current;
                    renderRunnerScores();
                    setupRunnerButtons();
                }
            } else {
                document.getElementById('totalSets').value = 1;
                testSets.total = 1;
                if (testSets.current > 1) {
                    testSets.current = 1;
                    document.getElementById('currentSetDisplay').innerText = 1;
                    renderRunnerScores();
                    setupRunnerButtons();
                }
            }
        }
        
        function changeSet(delta) {
            if (isRunning || isPaused) return; 

            const newSet = testSets.current + delta;
            
            if (newSet >= 1 && newSet <= testSets.total) {
                testSets.current = newSet;
                document.getElementById('currentSetDisplay').innerText = testSets.current;
                
                renderRunnerScores(); 
                setupRunnerButtons();
            }
        }
        
        function toggleButtonsState() {
             const input = document.getElementById('totalSets');
             const hasRecordedScores = Object.keys(testSets.data).length > 0;
             const navButtons = document.querySelectorAll('.set-nav-btn');
             
             input.disabled = isRunning;
             
             navButtons.forEach(btn => btn.disabled = isRunning);

             document.getElementById('export-options-container').style.display = hasRecordedScores ? 'flex' : 'none';
             document.getElementById('pdf-export-btn').style.display = hasRecordedScores ? 'inline-block' : 'none';

             const nextSetBtn = document.getElementById('next-set-btn');
             nextSetBtn.style.display = (isRunning || isPaused) ? 'inline-block' : 'none';

             document.getElementById('start-btn').style.display = !isRunning && !isPaused ? 'inline-block' : 'none';
             document.getElementById('reset-btn').style.display = isRunning || isPaused || hasRecordedScores ? 'inline-block' : 'none';
             document.getElementById('pause-btn').style.display = isRunning || isPaused ? 'inline-block' : 'none';
             
             // Pilot button logic: Always visible when not running or paused
             document.getElementById('pilot-btn').style.display = (isRunning || isPaused) ? 'none' : 'inline-block';
        }


        function finishTestAndAdvance() {
            if (!isRunning && !isPaused) return; 
            
            exportToPDF();
            finishTest(true); 
        }
        
        function getFormattedScore(totalCompleted) {
            if (totalCompleted <= 0) return "Level 1 - Lap 0";
            
            for (let i = pacerData.length - 1; i >= 0; i--) {
                const prevCum = (i > 0) ? pacerData[i-1].cumulative : 0;
                
                if (totalCompleted > prevCum) {
                    const level = pacerData[i].level;
                    const lap = totalCompleted - prevCum;
                    return `Level ${level} - Lap ${lap}`;
                }
            }
            
            if (totalCompleted === 1) return "Level 1 - Lap 1";
            
            return "Test Completed";
        }


        function saveRunnerScore(runnerId) {
            const uniqueKey = `${testSets.current}-${runnerId}`;
            
            if (testSets.data[uniqueKey]) {
                delete testSets.data[uniqueKey];
            } else {
                const completedLaps = totalCumulativeLaps; 
                
                if (completedLaps <= 0) { 
                    const statusText = document.getElementById('status-text').innerText;
                    document.getElementById('status-text').innerText = "‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
                    document.getElementById('status-text').style.color = "#e74c3c";
                    setTimeout(() => {
                        if (document.getElementById('status-text').innerText.includes("‚ö†Ô∏è")) {
                            document.getElementById('status-text').innerText = isPaused ? "PAUSED" : (isRunning ? "Running..." : "Ready to Start");
                            document.getElementById('status-text').style.color = isPaused ? "#f39c12" : "var(--text-main)";
                        }
                    }, 2000);
                    return;
                }

                const levelLapStr = getFormattedScore(completedLaps);
                const distance = completedLaps * 20;
                const distStr = distance.toLocaleString();

                testSets.data[uniqueKey] = {
                    runnerId: runnerId,
                    set: testSets.current,
                    score: completedLaps,
                    levelLap: levelLapStr,
                    distance: distStr,
                    time: document.getElementById('total-time').innerText
                };
            }
            
            renderRunnerScores();
            toggleButtonsState(); 
        }
        
        function renderRunnerScores() {
            const list = document.getElementById('saved-results-list');
            list.innerHTML = ''; 
            
            const recordedScores = Object.keys(testSets.data)
                .map(key => ({ key, data: testSets.data[key] }))
                .sort((a, b) => {
                    const [setA, idA] = a.key.split('-').map(Number);
                    const [setB, idB] = b.key.split('-').map(Number);
                    if (setA !== setB) return setA - setB;
                    return idA - idB;
                });

            if (recordedScores.length === 0) {
                list.innerHTML = '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</li>';
                document.querySelectorAll('.runner-score-btn').forEach(btn => {
                    btn.classList.remove('recorded');
                    const runnerId = btn.className.match(/runner-id-(\d+)/)[1];
                    btn.innerText = `#${runnerId}`;
                });
                return;
            }

            let lastSet = 0;
            document.querySelectorAll('.runner-score-btn').forEach(btn => {
                 btn.classList.remove('recorded');
                 const runnerId = btn.className.match(/runner-id-(\d+)/)[1];
                 btn.innerText = `#${runnerId}`;
            });

            recordedScores.forEach(({ data }) => {
                if (data.set !== lastSet) {
                    const setHeader = document.createElement('li');
                    setHeader.className = 'results-title';
                    setHeader.style.marginTop = lastSet === 0 ? '0' : '15px';
                    setHeader.style.borderBottom = '1px solid #ddd';
                    setHeader.style.color = 'var(--text-main)';
                    setHeader.style.paddingBottom = '2px';
                    setHeader.innerHTML = `‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${data.set} (${data.set}/${testSets.total}):`;
                    list.appendChild(setHeader);
                    lastSet = data.set;
                }

                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="runner-id">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö #${data.runnerId}</span>
                    <span class="runner-score-detail">
                        ${data.levelLap} | ‡∏£‡∏ß‡∏° **${data.score}** ‡∏£‡∏≠‡∏ö | ${data.distance} ‡∏°. | ‡πÄ‡∏ß‡∏•‡∏≤: ${data.time}
                    </span>
                `;
                list.appendChild(listItem);
                
                if (data.set === testSets.current) {
                    const btn = document.querySelector(`.runner-buttons-grid .runner-id-${data.runnerId}`);
                    if (btn) {
                        btn.classList.add('recorded');
                        btn.innerText = `#${data.runnerId} (${data.score})`;
                    }
                }
            });
        }
        
        function setupRunnerButtons() {
            const grid = document.getElementById('runner-buttons');
            grid.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'runner-score-btn runner-id-' + i; 
                btn.innerText = `#${i}`;
                btn.setAttribute('onclick', `saveRunnerScore(${i})`);
                grid.appendChild(btn);
            }
            renderRunnerScores();
        }

        function updateDisplay() {
            const currentData = pacerData[currentLevelIndex];
            document.getElementById('level-display').innerText = currentData.level;
            document.getElementById('speed-display').innerText = currentData.speed.toFixed(1);
            document.getElementById('shuttle-display').innerText = currentShuttleCount + 1;
            document.getElementById('cum-display').innerText = totalCumulativeLaps; 
            
            const distance = totalCumulativeLaps * 20;
            document.getElementById('dist-display').innerText = distance.toLocaleString();
            
            const completedLaps = totalCumulativeLaps;
            const levelLapStr = getFormattedScore(completedLaps);
            const distStr = distance.toLocaleString();
            
            document.getElementById('score-text').innerText = `${levelLapStr} | ‡∏£‡∏ß‡∏° ${completedLaps} ‡∏£‡∏≠‡∏ö | ${distStr} ‡∏°.`;
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        function playTone() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.frequency.value = 600;
            gain.gain.value = 0.5;

            osc.start();
            osc.stop(audioCtx.currentTime + 0.7);
        }

        function speak(text) {
             if (!('speechSynthesis' in window)) return;

             speechSynthesis.cancel();
             const u = new SpeechSynthesisUtterance(text);
             u.lang = 'th-TH';
             u.rate = 1.0;
             u.pitch = 1.2;
             if (thaiVoice) u.voice = thaiVoice;

             speechSynthesis.speak(u);
        }
        
        function startInterval() {
            timerInterval = setInterval(() => {
                if (isPaused) return; 

                const now = Date.now();
                const totalElapsed = now - startTime;
                document.getElementById('total-time').innerText = formatTime(totalElapsed);

                const shuttleElapsed = (now - shuttleStartTime) / 1000;
                let remaining = shuttleDuration - shuttleElapsed;
                
                // Ensure remaining time is not negative visually
                remaining = Math.max(0, remaining);

                if (remaining <= 0.02) { // Allow for a small margin of error before triggering nextShuttle
                    nextShuttle();
                } else {
                    document.getElementById('countdown-display').innerText = remaining.toFixed(2);
                    const percent = (shuttleElapsed / shuttleDuration) * 100;
                    document.getElementById('progress-fill').style.width = `${percent}%`;
                }
            }, 20);
        }

        function startTest() {
            if (isRunning) return;
            
            initAudio();
            toggleButtonsState();

            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('reset-btn').style.display = 'none'; 
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('next-set-btn').style.display = 'none';
            
            let countdown = 8;
            document.getElementById('status-text').innerText = `Starting in ${countdown}...`;
            
            const preStartInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('status-text').innerText = `Starting in ${countdown}...`;
                    
                    if (countdown === 1) { // NEW: Add tone for the last second
                        const thaiNumbers = ["", "‡∏´‡∏ô‡∏∂‡πà‡∏á", "‡∏™‡∏≠‡∏á", "‡∏™‡∏≤‡∏°", "‡∏™‡∏µ‡πà", "‡∏´‡πâ‡∏≤"];
                        speak(thaiNumbers[countdown]);
                        playTone(); 
                    } else if (countdown <= 5) {
                        const thaiNumbers = ["", "‡∏´‡∏ô‡∏∂‡πà‡∏á", "‡∏™‡∏≠‡∏á", "‡∏™‡∏≤‡∏°", "‡∏™‡∏µ‡πà", "‡∏´‡πâ‡∏≤"];
                        speak(thaiNumbers[countdown]);
                    }
                    
                } else {
                    clearInterval(preStartInterval);
                    document.getElementById('status-text').innerText = "RUN!";
                    beginPacerLogic();
                }
            }, 1000);
        }

        function beginPacerLogic() {
            isRunning = true;
            isPaused = false;
            
            toggleButtonsState(); 
            
            document.getElementById('pause-btn').innerText = "PAUSE";
            document.getElementById('pause-btn').style.backgroundColor = 'var(--pause-color)';
            document.getElementById('status-text').innerText = "Running...";
            document.getElementById('status-text').style.color = "var(--text-main)";
            
            if (startTime === 0) { 
                 startTime = Date.now();
                 currentLevelIndex = 0;
                 currentShuttleCount = 0;
                 totalCumulativeLaps = 0;
            }

            startShuttle(); 

            startInterval(); 
        }

        function togglePause() {
            const pauseBtn = document.getElementById('pause-btn');
            
            if (!isPaused) {
                isPaused = true;
                clearInterval(timerInterval); 
                pauseStartTimestamp = Date.now();
                
                pauseBtn.innerText = "RESUME";
                pauseBtn.style.backgroundColor = "#27ae60"; 
                document.getElementById('status-text').innerText = "PAUSED";
                document.getElementById('status-text').style.color = "#f39c12";
                
                toggleButtonsState(); 

            } else {
                isPaused = false;
                const now = Date.now();
                const pauseDuration = now - pauseStartTimestamp; 
                
                startTime += pauseDuration;
                shuttleStartTime += pauseDuration;

                pauseBtn.innerText = "PAUSE";
                pauseBtn.style.backgroundColor = "var(--pause-color)";
                document.getElementById('status-text').innerText = "Running...";
                document.getElementById('status-text').style.color = "var(--text-main)";

                startInterval(); 
                toggleButtonsState();
            }
        }

        function startShuttle() {
            const currentLevelData = pacerData[currentLevelIndex];
            shuttleDuration = currentLevelData.seconds;
            shuttleStartTime = Date.now();
            updateDisplay();

            document.getElementById('progress-fill').style.width = '0%';
        }

        function nextShuttle() {
            totalCumulativeLaps++; 
            
            const currentLevelData = pacerData[currentLevelIndex];

            currentShuttleCount++;
            
            if (currentShuttleCount > currentLevelData.shuttles) { 
                currentLevelIndex++;
                currentShuttleCount = 1; 

                if (currentLevelIndex >= pacerData.length) {
                    finishTest(); 
                    return;
                }

                playTone();
                // Speak new level number
                speak(`‡∏£‡∏∞‡∏î‡∏±‡∏ö ${pacerData[currentLevelIndex].level} ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß`);
                document.getElementById('status-text').innerText = `Level ${pacerData[currentLevelIndex].level} Started!`;
            } else {
                playTone();
                document.getElementById('status-text').innerText = "Turn Around & Run!";
            }

            startShuttle();
        }

        function finishTest(isManualFinish = false) {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false; 
            
            document.getElementById('status-text').style.color = "var(--text-main)";
            document.getElementById('countdown-display').innerText = "0.00";
            document.getElementById('progress-fill').style.width = "100%";
            
            updateDisplay(); 
            playTone();
            playTone();
            
            if (testSets.current < testSets.total && (isManualFinish || currentLevelIndex >= pacerData.length)) {
                // Advance set and prepare for the next run
                showModal('‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏î‡∏™‡∏≠‡∏ö', `‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${testSets.current} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ä‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ: ${testSets.current + 1}`, false);
                changeSet(1); 
                performReset(true); 
                document.getElementById('status-text').innerText = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ!";
            } else {
                document.getElementById('status-text').innerText = "Test Completed! (‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö)";
                document.getElementById('start-btn').innerText = 'START NEW TEST';
                document.getElementById('pause-btn').style.display = 'none';
                document.getElementById('next-set-btn').style.display = 'none';
                toggleButtonsState(); 
            }
        }
        
        // **NEW** - Separated reset logic from confirmation
        function performReset(keepScores = false) {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false;
            currentLevelIndex = 0;
            currentShuttleCount = 0;
            totalCumulativeLaps = 0; 
            startTime = 0; 
            
            toggleButtonsState();

            document.getElementById('level-display').innerText = "1";
            document.getElementById('shuttle-display').innerText = "1";
            document.getElementById('speed-display').innerText = "8.5";
            document.getElementById('cum-display').innerText = "0"; 
            document.getElementById('dist-display').innerText = "0";
            document.getElementById('score-text').innerText = "Level 1 - Lap 0 | ‡∏£‡∏ß‡∏° 0 ‡∏£‡∏≠‡∏ö | 0 ‡∏°."; 
            
            if (!keepScores) {
                testSets.data = {};
                testSets.current = 1;
                document.getElementById('totalSets').value = 1;
                testSets.total = 1;
                document.getElementById('currentSetDisplay').innerText = `1`;
            }

            renderRunnerScores(); 
            setupRunnerButtons(); 
            
            document.getElementById('countdown-display').innerText = "0.00";
            document.getElementById('total-time').innerText = "00:00";
            document.getElementById('status-text').innerText = "Ready to Start";
            document.getElementById('status-text').style.color = "var(--text-main)";
            document.getElementById('progress-fill').style.width = "0%";
            
            document.getElementById('start-btn').style.display = 'inline-block';
            document.getElementById('start-btn').innerText = 'START TEST';
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('next-set-btn').style.display = 'none';
            toggleButtonsState(); 
            
            closeModal(); 
        }

        function resetTest(keepScores = false) {
            // **Replaced prompt/alert with custom modal**
            if (!keepScores) {
                showPasswordModal(() => {
                    // Password correct, proceed with full reset
                    performReset(false);
                    showModal('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', false);
                });
            } else {
                // Used for automatic reset/advance to the next set (keepScores=true)
                performReset(true);
            }
        }
        
        // --- Pilot Data Generation ---
        function generatePilotData() {
            const runnerCount = 10;
            const set = testSets.current;
            
            for (let i = 1; i <= runnerCount; i++) {
                const randomLaps = Math.floor(Math.random() * 55) + 5;
                const levelLapStr = getFormattedScore(randomLaps);
                const distance = randomLaps * 20;
                
                const uniqueKey = `${set}-${i}`;
                testSets.data[uniqueKey] = {
                    runnerId: i,
                    set: set,
                    score: randomLaps,
                    levelLap: levelLapStr,
                    distance: distance.toLocaleString(),
                    time: "Pilot Test"
                };
            }
            
            renderRunnerScores();
            toggleButtonsState();
            
            showModal('üß™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà ${set} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, false);
        }

        // --- PDF Export Logic ---
        function exportToPDF() {
            if (Object.keys(testSets.data).length === 0) {
                 showModal("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å", true);
                return;
            }
            
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                 showModal("‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î jsPDF", "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î jsPDF... ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå jspdf.umd.min.js ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", true);
                 return;
            }

            const { jsPDF } = window.jspdf;
            
            const currentSet = testSets.current;
            const today = new Date().toISOString().slice(0, 10);
            const exportAll = document.getElementById('exportAllSets').checked;
            
            let filename;
            if (exportAll) {
                filename = `PACER_AllSets_${today}.pdf`;
            } else {
                filename = `PACER_Set_${currentSet}_${today}.pdf`;
            }

            // Using A4 standard size (210 x 297 mm)
            const doc = new jsPDF('p', 'mm', 'a4'); 
            let y = 10;
            const lineHeight = 7;
            const padding = 15; // Increased padding for better appearance
            
            // Note: jsPDF does not natively support Thai fonts without custom font registration (which is complex/unreliable in a single-file setup). Using default Helvetica/Times.
            
            doc.setFont("Helvetica", "bold");
            doc.setFontSize(16);
            doc.text(exportAll ? "PACER Test Score Summary (All Sets)" : "PACER Test Score Summary (Single Set)", padding, y); 
            y += lineHeight;

            doc.setFontSize(10);
            doc.setFont("Helvetica", "normal");
            doc.text(`Export Date: ${today}`, padding, y);
            if (!exportAll) {
                doc.text(`Current Set: ${currentSet} of ${testSets.total}`, 100, y); 
            } else {
                doc.text(`Total Test Sets: ${testSets.total}`, 100, y); 
            }
            y += lineHeight * 2;

            let scores = Object.keys(testSets.data)
                .map(key => ({ key, data: testSets.data[key] }))
                .filter(item => exportAll || item.data.set === currentSet)
                .sort((a, b) => {
                    const [setA, idA] = a.key.split('-').map(Number);
                    const [setB, idB] = b.key.split('-').map(Number);
                    if (setA !== setB) return setA - setB;
                    return idA - idB;
                });
            
            if (scores.length === 0) {
                showModal("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", true);
                return;
            }

            doc.setFontSize(10);
            let lastSet = 0;

            scores.forEach(({ data }) => {
                if (y > 280) { 
                    doc.addPage();
                    y = padding;
                    doc.setFont("Helvetica", "normal");
                    doc.setFontSize(10);
                    lastSet = 0; 
                }

                if (data.set !== lastSet) {
                    y += lineHeight;
                    doc.setFont("Helvetica", "bold");
                    doc.setFontSize(12);
                    doc.text(`--- Test Set ${data.set} ---`, padding, y); 
                    y += lineHeight;
                    lastSet = data.set;
                    doc.setFont("Helvetica", "normal");
                    doc.setFontSize(10);
                }

                const scoreLine = `Runner #${data.runnerId}: ${data.levelLap} | Total Laps: ${data.score} | Distance: ${data.distance} m | Time: ${data.time}`;
                
                doc.text(scoreLine, padding, y);
                y += lineHeight;
            });

            doc.save(filename);
        }

        const pacerData = [
            { level: 1,  shuttles: 7,  seconds: 8.47, speed: 8.5, cumulative: 0 }, // Init cumulative to 0, it will be calculated below
            { level: 2,  shuttles: 8,  seconds: 8.00, speed: 9.0, cumulative: 0 },
            { level: 3,  shuttles: 8,  seconds: 7.58, speed: 9.5, cumulative: 0 },
            { level: 4,  shuttles: 8,  seconds: 7.20, speed: 10.0, cumulative: 0 },
            { level: 5,  shuttles: 9,  seconds: 6.86, speed: 10.5, cumulative: 0 },
            { level: 6,  shuttles: 9,  seconds: 6.55, speed: 11.0, cumulative: 0 },
            { level: 7,  shuttles: 10, seconds: 6.26, speed: 11.5, cumulative: 0 },
            { level: 8,  shuttles: 10, seconds: 6.00, speed: 12.0, cumulative: 0 },
            { level: 9,  shuttles: 10, seconds: 5.76, speed: 12.5, cumulative: 0 },
            { level: 10, shuttles: 11, seconds: 5.54, speed: 13.0, cumulative: 0 },
            { level: 11, shuttles: 11, seconds: 5.33, speed: 13.5, cumulative: 0 },
            { level: 12, shuttles: 12, seconds: 5.14, speed: 14.0, cumulative: 0 },
            { level: 13, shuttles: 12, seconds: 4.97, speed: 14.5, cumulative: 0 },
            { level: 14, shuttles: 13, seconds: 4.80, speed: 15.0, cumulative: 0 },
            { level: 15, shuttles: 13, seconds: 4.65, speed: 15.5, cumulative: 0 },
            { level: 16, shuttles: 13, seconds: 4.50, speed: 16.0, cumulative: 0 },
            { level: 17, shuttles: 14, seconds: 4.36, speed: 16.5, cumulative: 0 },
            { level: 18, shuttles: 14, seconds: 4.24, speed: 17.0, cumulative: 0 },
            { level: 19, shuttles: 15, seconds: 4.11, speed: 17.5, cumulative: 0 },
            { level: 20, shuttles: 15, seconds: 4.00, speed: 18.0, cumulative: 0 },
            { level: 21, shuttles: 15, seconds: 3.89, speed: 18.5, cumulative: 0 }
        ];

        let cumulativeLapsTotalPacer = 0;
        pacerData.forEach(data => {
            cumulativeLapsTotalPacer += data.shuttles;
            data.cumulative = cumulativeLapsTotalPacer;
        });
        
        window.onload = function() {
            setupRunnerButtons();
            document.getElementById('currentSetDisplay').innerText = `1`;
            document.getElementById('cum-display').innerText = "0";
            document.getElementById('dist-display').innerText = "0";
            document.getElementById('score-text').innerText = "Level 1 - Lap 0 | ‡∏£‡∏ß‡∏° 0 ‡∏£‡∏≠‡∏ö | 0 ‡∏°.";
            
            // Expose functions globally for HTML elements
            window.toggleFont = toggleFont;
            window.updateTotalSets = updateTotalSets;
            window.changeSet = changeSet;
            window.startTest = startTest;
            window.togglePause = togglePause;
            window.finishTestAndAdvance = finishTestAndAdvance;
            window.resetTest = resetTest;
            window.exportToPDF = exportToPDF;
            window.generatePilotData = generatePilotData;
            window.closeModal = closeModal; // Ensure modal is closable
        };
    </script>
</body>
</html>
