<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PACER Test Timer (AI Powered)</title>
    
    <!-- Import Google Fonts: Prompt and Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Import jsPDF Library for PDF generation (kept but no longer used for core export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-color: #f4f6f8;
            --container-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --accent-color: #3498db; /* Blue */
            --highlight-color: #e67e22; /* Orange for Laps */
            --timer-color: #27ae60; /* Green */
            --countdown-color: #e74c3c; /* Red */
            --pause-color: #f39c12; /* Yellow/Orange for Pause */
            --speed-color: #9b59b6; /* Purple for Speed */
            --ai-color: #8e44ad; /* Purple for AI features */
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --font-main: 'Prompt', sans-serif;
            --font-alt: 'Sarabun', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            transition: font-family 0.3s ease;
        }

        .container {
            text-align: center;
            background-color: var(--container-bg);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 800px;
            position: relative;
        }

        /* กลุ่มปุ่มตั้งค่ามุมขวาบน */
        .settings-group {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .toggle-btn {
            background: #ecf0f1;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            color: var(--text-main);
            font-size: 14px;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }
        .toggle-btn:hover {
            background: #dcdcdc;
        }
        
        h1 {
            margin-bottom: 30px;
            margin-top: 40px;
            font-size: 28px;
            color: var(--accent-color);
            font-weight: 700;
        }
        
        /* NEW: Test Set Input Styles */
        .set-input-group {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            font-size: 16px;
        }

        .set-input-group input {
            width: 50px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
        }


        /* Grid ปรับเป็น 2 คอลัมน์ในมือถือ และ 3 คอลัมน์ในจอใหญ่เพื่อให้แสดง Speed ได้สวยงาม */
        .display-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* Mobile: 2 columns */
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 600px) {
            .display-grid {
                grid-template-columns: repeat(3, 1fr); /* Desktop: 3 columns (แถวบน 3, แถวล่าง 2) */
            }
        }

        .stat-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-main);
        }

        /* สีพิเศษ */
        #cum-display { color: var(--highlight-color); }
        #dist-display { color: var(--accent-color); }
        #speed-display { color: var(--speed-color); }

        .timer-display {
            font-size: 20px;
            color: var(--text-sub);
            margin-top: 15px;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
        }
        
        #total-time {
            color: var(--timer-color);
            font-weight: 700;
            font-size: 24px;
        }
        
        .score-display {
            background-color: #edf7ed;
            color: #1e4620;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: 600;
            border: 1px solid #c8e6c9;
            line-height: 1.5;
        }
        
        #score-text {
            color: #2e7d32;
            font-weight: 700;
            font-size: 20px;
            display: block; /* ขึ้นบรรทัดใหม่ในจอมือถือเล็กๆ ถ้าจำเป็น */
            margin-top: 5px;
        }
        
        /* NEW: Runner Score Buttons */
        .score-buttons-container {
            margin-top: 30px;
            padding: 15px;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            background-color: #fcfcfc;
            border-radius: 10px;
        }

        .score-label-btn {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 10px;
        }

        .runner-buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 buttons per row on small screens */
            gap: 8px;
        }

        @media (min-width: 600px) {
            .runner-buttons-grid {
                grid-template-columns: repeat(10, 1fr); /* 10 buttons per row on large screens */
                gap: 10px;
            }
        }
        
        .runner-score-btn {
            background-color: #34495e; /* Darker blue/gray */
            color: white;
            border: none;
            padding: 10px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            line-height: 1;
        }
        .runner-score-btn:hover {
            background-color: #2c3e50;
            transform: none; 
        }
        /* แก้ไข: ลดการขยายเมื่อกด */
        .runner-score-btn:active {
            transform: scale(0.98); 
        }
        .runner-score-btn.recorded {
            background-color: var(--timer-color); /* Green when recorded */
            color: white;
            font-weight: bold;
        }

        /* NEW: Saved Results Display */
        .saved-results-container {
            margin-top: 30px;
            text-align: left;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 12px;
        }

        .results-title {
            font-size: 20px;
            color: var(--highlight-color);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--highlight-color);
            padding-bottom: 5px;
            font-weight: 700;
        }

        .results-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .results-list li {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
            font-size: 16px;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .results-list li:last-child {
            border-bottom: none;
        }
        .runner-id {
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 2px;
        }
        .runner-score-detail {
            color: #555;
            font-size: 14px;
            line-height: 1.4;
        }


        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        button.action-btn {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            padding: 18px 40px;
            font-size: 20px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            font-family: inherit;
            min-width: 180px;
        }

        button.action-btn:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        button.action-btn:active {
            transform: scale(0.98);
        }
        
        button.action-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ปุ่ม Analyze AI */
        button.analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }

        /* ปุ่ม End Set (สีม่วงสำหรับจบชุดก่อนเวลา) */
        button.end-set-btn {
            background-color: #8e44ad;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            margin-top: 25px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        .status-text {
            margin-top: 20px;
            font-size: 22px;
            color: var(--text-main);
            font-weight: 600;
            height: 30px;
        }

        .next-beep-box {
            background-color: #fff3cd; /* Light yellow bg for alert */
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        #countdown-display {
            color: var(--countdown-color);
            font-size: 36px;
        }

        /* Modal Styles for AI Output */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: left;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--ai-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .ai-loading {
            text-align: center;
            color: #777;
            padding: 20px;
        }
        
        .ai-result {
            line-height: 1.6;
            white-space: pre-wrap;
            color: #333;
        }
        
        /* NEW: Print Media Queries for Ctrl+P like output */
        @media print {
            body {
                background: none;
                margin: 0;
                padding: 0;
            }
            .container {
                box-shadow: none;
                padding: 10mm; /* Add internal padding for printing */
                width: auto;
                max-width: none;
            }
            /* Hide non-essential interactive elements */
            .settings-group,
            .set-input-group input, /* Hide only the input box, keep the label */
            .score-buttons-container,
            .button-group,
            .progress-bar,
            .next-beep-box,
            #ai-modal {
                display: none !important;
            }
            /* Adjust layout for print */
            .display-grid {
                grid-template-columns: repeat(5, 1fr) !important; /* Force 5 columns */
                gap: 5px;
                margin-bottom: 20px;
            }
            .stat-box {
                border: 1px solid #ccc;
                padding: 10px;
                background-color: #fff;
            }
            /* Ensure results list looks clean */
            .results-list li {
                border-bottom: 1px solid #ccc;
                page-break-inside: avoid; /* Avoid breaking list items across pages */
            }
            h1 {
                margin-top: 0;
            }
            /* Ensure the display elements retain their styles */
            .score-display {
                box-shadow: none;
                border: 1px solid #c8e6c9;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="settings-group">
            <button class="toggle-btn" id="font-btn" onclick="toggleFont()">เปลี่ยนฟอนต์: Prompt</button>
        </div>

        <h1>PACER Test Timer</h1>
        
        <!-- Test Set Input (Start) -->
        <div class="set-input-group">
            <label for="totalSets">จำนวนชุดการทดสอบ:</label>
            <input type="number" id="totalSets" value="1" min="1" onchange="updateTotalSets(this.value); toggleButtonsState();" oninput="toggleButtonsState()">
            <div id="currentSetDisplay">ชุดปัจจุบัน: 1</div>
        </div>

        <div class="display-grid">
            <div class="stat-box">
                <div class="stat-label">Level</div>
                <div class="stat-value" id="level-display">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Laps</div>
                <div class="stat-value" id="shuttle-display">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Speed</div>
                <div class="stat-value" id="speed-display">8.5</div>
                <div class="stat-label" style="font-size: 10px; margin-top: -5px;">km/h</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Cum. Laps</div>
                <div class="stat-value" id="cum-display">0</div> 
            </div>
            <div class="stat-box">
                <div class="stat-label">Distance (m)</div>
                <div class="stat-value" id="dist-display">0</div>
            </div>
        </div>

        <div class="next-beep-box">
             <div class="stat-label" style="color: #856404;">Next Beep In (วินาที)</div>
             <div class="stat-value" id="countdown-display">0.00</div>
        </div>

        <div class="timer-display">Total Time: <span id="total-time">00:00</span></div>
        
        <!-- ส่วนแสดงคะแนนสำหรับจดบันทึก -->
        <div class="score-display">
            บันทึกผล (Score): <span id="score-text">Level 1 - Lap 0 | รวม 0 รอบ | 0 ม.</span>
        </div>
        
        <div class="status-text" id="status-text">Ready to Start</div>
        
        <!-- Runner Score Buttons -->
        <div class="score-buttons-container">
            <div class="score-label-btn">บันทึกผลผู้ทดสอบ: (กดเพื่อบันทึก/ยกเลิกคะแนนปัจจุบัน)</div>
            <div id="runner-buttons" class="runner-buttons-grid">
                <!-- Buttons 1-10 will be generated here by JS -->
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="button-group">
            <button id="start-btn" class="action-btn" onclick="startTest()">START TEST</button>
            <button id="pause-btn" class="action-btn" onclick="togglePause()" style="display: none; background-color: var(--pause-color); box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);">PAUSE</button>
            
            <!-- ปุ่มจบชุดการทดสอบ/เริ่มชุดต่อไปแบบ Manual -->
            <button id="next-set-btn" class="action-btn end-set-btn" onclick="finishTestAndAdvance()" style="display: none;">▶️ เริ่มชุดต่อไป (Manual)</button>

            <button id="reset-btn" class="action-btn" onclick="resetTest()" style="display: none; background-color: #e74c3c; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);">RESET ALL</button>
            
            <!-- ปุ่มวิเคราะห์ผลด้วย AI จะแสดงเมื่อมีคะแนนบันทึกแล้ว -->
            <button id="analyze-btn" class="action-btn analyze-btn" onclick="analyzePerformance()" style="display: none;">✨ วิเคราะห์ผล (AI)</button>
            <!-- NEW: PDF Export Button -->
            <button id="pdf-export-btn" class="action-btn analyze-btn" onclick="exportToPDF()" style="display: none;">⬇️ ส่งออกเป็น PDF</button>
        </div>
        
        <!-- Saved Results Display -->
        <div class="saved-results-container">
            <h2 class="results-title">ผลการบันทึก:</h2>
            <ul id="saved-results-list" class="results-list">
                <li>ยังไม่มีการบันทึกผลผู้ทดสอบ</li>
            </ul>
        </div>
    </div>

    <!-- AI Modal -->
    <div class="modal-overlay" id="ai-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">✨ Gemini AI Says:</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="ai-content" class="ai-result">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // === Gemini API Setup ===
        const apiKey = ""; // API Key provided by environment

        async function callGemini(prompt) {
            // Added simple exponential backoff for robustness
            const maxRetries = 3;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    // Using a dummy response if apiKey is empty for development purposes
                    if (apiKey === "") {
                         return new Promise(resolve => setTimeout(() => {
                            resolve(`
                                **1. การประเมินผล:**
                                คะแนนของคุณคือ Level 5 - Lap 3 (รวม 39 รอบ) นับเป็นการเริ่มต้นที่ดีมาก! แสดงให้เห็นถึงระดับความฟิตของหัวใจและหลอดเลือดที่แข็งแรง
                                
                                **2. เคล็ดลับการฝึกซ้อม:**
                                ลองฝึกซ้อมแบบ **Interval Training** โดยการสลับวิ่งเร็วในระยะทางสั้นๆ (เช่น 200 เมตร) กับการเดินหรือวิ่งเบาๆ (เช่น 400 เมตร) ซ้ำไปมา 5-8 รอบ จะช่วยเพิ่มขีดความสามารถในการเผาผลาญออกซิเจน (VO2 max) และยืดเวลาที่คุณสามารถวิ่งที่ความเร็วสูงได้
                            `);
                        }, 1500));
                    }
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Gemini API Error after retries:", error);
                        return "เกิดข้อผิดพลาดในการเชื่อมต่อกับ AI กรุณาลองใหม่อีกครั้ง";
                    }
                    // Wait for exponential time before retrying
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
        }

        function showModal(content, isLoading = false) {
            const modal = document.getElementById('ai-modal');
            const contentDiv = document.getElementById('ai-content');
            
            modal.style.display = 'flex';
            
            if (isLoading) {
                contentDiv.innerHTML = '<div class="ai-loading">กำลังปรึกษา Gemini AI... ✨<br>(กรุณารอสักครู่)</div>';
            } else {
                contentDiv.innerText = content;
            }
        }

        function closeModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        // Feature: Analyze Performance
        async function analyzePerformance() {
            const completedLaps = totalCumulativeLaps; 

            if (completedLaps <= 1) { 
                 showModal("กรุณาวิ่งให้จบอย่างน้อย 1-2 รอบก่อนทำการวิเคราะห์ผลด้วย AI ครับ/ค่ะ", false);
                 return;
            }

            const scoreText = document.getElementById('score-text').innerText;
            
            showModal("", true);
            
            const prompt = `Analyze this PACER test (Beep Test) result for a general user: 
            Full Score Detail: ${scoreText}
            
            Please provide:
            1. A short assessment of this fitness level (e.g. Good start, Excellent, Needs work).
            2. One specific, actionable training tip to improve stamina for next time.
            
            Respond in Thai language. Keep the tone friendly and encouraging.`;
            
            const text = await callGemini(prompt);
            showModal(text);
        }

        // === State Management ===
        let currentFont = 'Prompt';
        let testSets = {
            total: 1, // Total number of test sets
            current: 1, // Current set being run
            data: {} // Stores scores: { '1-1': {score: 7, ...}, '2-5': {...} }
        };
        let currentLevelIndex = 0;
        let currentShuttleCount = 0;
        let totalCumulativeLaps = 0; // รอบที่เสร็จสมบูรณ์แล้ว
        
        let isRunning = false;
        let isPaused = false;
        let startTime = 0;
        let timerInterval;
        let shuttleStartTime = 0;
        let shuttleDuration = 0;
        let pauseStartTimestamp = 0;
        let audioCtx = null;


        function initAudio() {
             if (!audioCtx) {
                 audioCtx = new (window.AudioContext || window.webkitAudioContext)();
             }
        }

        let thaiVoice = null;
        speechSynthesis.onvoiceschanged = () => {
             const voices = speechSynthesis.getVoices();
             thaiVoice = voices.find(v => v.lang === 'th-TH') || null;
        };

        function toggleFont() {
            const body = document.body;
            const btn = document.getElementById('font-btn');
            if (body.style.fontFamily.includes('Prompt')) {
                body.style.fontFamily = `'Sarabun', sans-serif`;
                btn.innerText = 'เปลี่ยนฟอนต์: Sarabun';
                currentFont = 'Sarabun';
            } else {
                body.style.fontFamily = `'Prompt', sans-serif`;
                btn.innerText = 'เปลี่ยนฟอนต์: Prompt';
                currentFont = 'Prompt';
            }
        }

        function updateTotalSets(value) {
            const total = parseInt(value);
            if (total >= 1) {
                testSets.total = total;
            } else {
                document.getElementById('totalSets').value = 1;
                testSets.total = 1;
            }
        }
        
        function toggleButtonsState() {
             const input = document.getElementById('totalSets');
             const hasRecordedScores = Object.keys(testSets.data).length > 0;
             
             input.disabled = isRunning;

             document.getElementById('pdf-export-btn').style.display = hasRecordedScores ? 'inline-block' : 'none';
             document.getElementById('analyze-btn').style.display = hasRecordedScores && !isRunning ? 'inline-block' : 'none';

             const nextSetBtn = document.getElementById('next-set-btn');
             nextSetBtn.style.display = (isRunning || isPaused) ? 'inline-block' : 'none';

             document.getElementById('start-btn').style.display = !isRunning && !isPaused ? 'inline-block' : 'none';
             document.getElementById('reset-btn').style.display = isRunning || isPaused || hasRecordedScores ? 'inline-block' : 'none';
             document.getElementById('pause-btn').style.display = isRunning || isPaused ? 'inline-block' : 'none';
        }


        function finishTestAndAdvance() {
            if (!isRunning && !isPaused) return; 
            
            finishTest(true); 
        }
        
        // --- Scoring and Display Logic ---
        
        function getFormattedScore(totalCompleted) {
            if (totalCompleted <= 0) return "Level 1 - Lap 0";
            
            for (let i = pacerData.length - 1; i >= 0; i--) {
                const prevCum = (i > 0) ? pacerData[i-1].cumulative : 0;
                
                if (totalCompleted > prevCum) {
                    const level = pacerData[i].level;
                    const lap = totalCompleted - prevCum;
                    return `Level ${level} - Lap ${lap}`;
                }
            }
            
            if (totalCompleted === 1) return "Level 1 - Lap 1";
            
            return "Test Completed / Invalid Score";
        }


        function saveRunnerScore(runnerId) {
            const uniqueKey = `${testSets.current}-${runnerId}`;
            const btn = document.querySelector(`.runner-buttons-grid .runner-id-${runnerId}`);

            if (testSets.data[uniqueKey]) {
                // Case 1: Already recorded -> Unrecord (Toggle OFF)
                delete testSets.data[uniqueKey];
                
                // Note: The UI for the button will be updated in renderRunnerScores
            } else {
                // Case 2: Not recorded -> Record (Toggle ON)
                const completedLaps = totalCumulativeLaps; 
                
                if (completedLaps <= 0) { 
                    const statusText = document.getElementById('status-text').innerText;
                    document.getElementById('status-text').innerText = "⚠️ Error: ต้องเริ่มวิ่ง (ปี๊บแรก) ก่อนบันทึกคะแนน";
                    document.getElementById('status-text').style.color = "#e74c3c";
                    setTimeout(() => {
                        if (document.getElementById('status-text').innerText.includes("⚠️ Error")) {
                            document.getElementById('status-text').innerText = isPaused ? "PAUSED" : (isRunning ? "Running..." : "Ready to Start");
                            document.getElementById('status-text').style.color = isPaused ? "#f39c12" : "var(--text-main)";
                        }
                    }, 3000);
                    return;
                }

                const levelLapStr = getFormattedScore(completedLaps);
                const distance = completedLaps * 20;
                const distStr = distance.toLocaleString();

                testSets.data[uniqueKey] = {
                    runnerId: runnerId,
                    set: testSets.current,
                    score: completedLaps,
                    levelLap: levelLapStr,
                    distance: distStr,
                    time: document.getElementById('total-time').innerText
                };
            }
            
            // Re-render UI after adding or deleting data
            renderRunnerScores();
            toggleButtonsState(); // Update PDF/AI buttons visibility based on data count
        }
        
        function renderRunnerScores() {
            const list = document.getElementById('saved-results-list');
            list.innerHTML = ''; 
            
            const recordedScores = Object.keys(testSets.data)
                .map(key => ({ key, data: testSets.data[key] }))
                .sort((a, b) => {
                    const [setA, idA] = a.key.split('-').map(Number);
                    const [setB, idB] = b.key.split('-').map(Number);
                    if (setA !== setB) return setA - setB;
                    return idA - idB;
                });

            if (recordedScores.length === 0) {
                list.innerHTML = '<li>ยังไม่มีการบันทึกผลผู้ทดสอบ</li>';
                // Clear all button states if no scores exist
                document.querySelectorAll('.runner-score-btn').forEach(btn => {
                    btn.classList.remove('recorded');
                    const runnerId = btn.className.match(/runner-id-(\d+)/)[1];
                    btn.innerText = `#${runnerId}`;
                });
                return;
            }

            let lastSet = 0;
            document.querySelectorAll('.runner-score-btn').forEach(btn => {
                 btn.classList.remove('recorded');
                 const runnerId = btn.className.match(/runner-id-(\d+)/)[1];
                 btn.innerText = `#${runnerId}`;
            });


            recordedScores.forEach(({ data }) => {
                if (data.set !== lastSet) {
                    const setHeader = document.createElement('li');
                    setHeader.className = 'results-title';
                    setHeader.style.marginTop = lastSet === 0 ? '0' : '15px';
                    setHeader.style.borderBottom = '1px solid #ddd';
                    setHeader.style.color = 'var(--text-main)';
                    setHeader.style.paddingBottom = '2px';
                    setHeader.innerHTML = `ชุดที่ ${data.set} (${data.set}/${testSets.total}):`;
                    list.appendChild(setHeader);
                    lastSet = data.set;
                }

                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="runner-id">ผู้ทดสอบ #${data.runnerId}</span>
                    <span class="runner-score-detail">
                        ${data.levelLap} | รวม **${data.score}** รอบ | ${data.distance} ม. | เวลา: ${data.time}
                    </span>
                `;
                list.appendChild(listItem);
                
                // Update the button for the CURRENT set
                if (data.set === testSets.current) {
                    const btn = document.querySelector(`.runner-buttons-grid .runner-id-${data.runnerId}`);
                    if (btn) {
                        btn.classList.add('recorded');
                        btn.innerText = `#${data.runnerId} (${data.score})`;
                    }
                }
            });
            
        }
        
        function setupRunnerButtons() {
            const grid = document.getElementById('runner-buttons');
            grid.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                btn.className = 'runner-score-btn runner-id-' + i; 
                btn.innerText = `#${i}`;
                btn.setAttribute('onclick', `saveRunnerScore(${i})`);
                grid.appendChild(btn);
            }
            renderRunnerScores();
        }


        function updateDisplay() {
            const currentData = pacerData[currentLevelIndex];
            document.getElementById('level-display').innerText = currentData.level;
            document.getElementById('speed-display').innerText = currentData.speed.toFixed(1);
            
            document.getElementById('shuttle-display').innerText = currentShuttleCount + 1;
            
            document.getElementById('cum-display').innerText = totalCumulativeLaps; 
            
            const distance = totalCumulativeLaps * 20;
            document.getElementById('dist-display').innerText = distance.toLocaleString();
            
            const completedLaps = totalCumulativeLaps;
            const levelLapStr = getFormattedScore(completedLaps);
            const distStr = distance.toLocaleString();
            
            document.getElementById('score-text').innerText = `${levelLapStr} | รวม ${completedLaps} รอบ | ${distStr} ม.`;
        }

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        // --- Core PACER Logic ---

        function playTone() {
            if (!audioCtx) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.frequency.value = 600;
            gain.gain.value = 0.5;

            osc.start();
            osc.stop(audioCtx.currentTime + 0.7);
        }

        function speak(text) {
             if (!('speechSynthesis' in window)) return;

             speechSynthesis.cancel();
             const u = new SpeechSynthesisUtterance(text);
             u.lang = 'th-TH';
             u.rate = 1.0;
             u.pitch = 1.2;
             if (thaiVoice) u.voice = thaiVoice;

             speechSynthesis.speak(u);
        }
        
        function startInterval() {
            timerInterval = setInterval(() => {
                if (isPaused) return; 

                const now = Date.now();
                const totalElapsed = now - startTime;
                document.getElementById('total-time').innerText = formatTime(totalElapsed);

                const shuttleElapsed = (now - shuttleStartTime) / 1000;
                const remaining = shuttleDuration - shuttleElapsed;

                if (remaining <= 0) {
                    nextShuttle();
                } else {
                    document.getElementById('countdown-display').innerText = remaining.toFixed(2);
                    const percent = (shuttleElapsed / shuttleDuration) * 100;
                    document.getElementById('progress-fill').style.width = `${percent}%`;
                }
            }, 20);
        }

        function startTest() {
            if (isRunning) return;
            
            initAudio();
            toggleButtonsState();

            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('reset-btn').style.display = 'none'; 
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('next-set-btn').style.display = 'none';
            
            let countdown = 8;
            document.getElementById('status-text').innerText = `Starting in ${countdown}...`;
            
            const preStartInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    document.getElementById('status-text').innerText = `Starting in ${countdown}...`;
                    
                    if (countdown <= 5) {
                        const thaiNumbers = ["", "หนึ่ง", "สอง", "สาม", "สี่", "ห้า"];
                        speak(thaiNumbers[countdown]);
                    }
                    
                } else {
                    clearInterval(preStartInterval);
                    document.getElementById('status-text').innerText = "RUN!";
                    beginPacerLogic();
                }
            }, 1000);
        }

        function beginPacerLogic() {
            isRunning = true;
            isPaused = false;
            
            toggleButtonsState(); 
            
            document.getElementById('pause-btn').innerText = "PAUSE";
            document.getElementById('pause-btn').style.backgroundColor = 'var(--pause-color)';
            document.getElementById('status-text').innerText = "Running...";
            document.getElementById('status-text').style.color = "var(--text-main)";
            
            if (startTime === 0) { 
                 startTime = Date.now();
                 currentLevelIndex = 0;
                 currentShuttleCount = 0;
                 totalCumulativeLaps = 0;
            }

            nextShuttle(); 

            startInterval(); 
        }

        function togglePause() {
            const pauseBtn = document.getElementById('pause-btn');
            
            if (!isPaused) {
                isPaused = true;
                clearInterval(timerInterval); 
                pauseStartTimestamp = Date.now();
                
                pauseBtn.innerText = "RESUME";
                pauseBtn.style.backgroundColor = "#27ae60"; 
                document.getElementById('status-text').innerText = "PAUSED";
                document.getElementById('status-text').style.color = "#f39c12";
                
                toggleButtonsState(); 

            } else {
                isPaused = false;
                const now = Date.now();
                const pauseDuration = now - pauseStartTimestamp; 
                
                startTime += pauseDuration;
                shuttleStartTime += pauseDuration;

                pauseBtn.innerText = "PAUSE";
                pauseBtn.style.backgroundColor = "var(--pause-color)";
                document.getElementById('status-text').innerText = "Running...";
                document.getElementById('status-text').style.color = "var(--text-main)";

                startInterval(); 
                toggleButtonsState();
            }
        }

        function startShuttle() {
            const currentLevelData = pacerData[currentLevelIndex];
            shuttleDuration = currentLevelData.seconds;
            shuttleStartTime = Date.now();
            updateDisplay();

            document.getElementById('progress-fill').style.width = '0%';
        }

        function nextShuttle() {
            totalCumulativeLaps++; 
            
            const currentLevelData = pacerData[currentLevelIndex];

            currentShuttleCount++;
            
            if (currentShuttleCount > currentLevelData.shuttles) { 
                currentLevelIndex++;
                currentShuttleCount = 1; 

                if (currentLevelIndex >= pacerData.length) {
                    finishTest(); 
                    return;
                }

                playTone();
                document.getElementById('status-text').innerText = `Level ${pacerData[currentLevelIndex].level} Started!`;
            } else {
                playTone();
                document.getElementById('status-text').innerText = "Turn Around & Run!";
            }

            startShuttle();
        }

        function finishTest(isManualFinish = false) {
            clearInterval(timerInterval);
            isRunning = false;
            
            document.getElementById('status-text').style.color = "var(--text-main)";
            document.getElementById('countdown-display').innerText = "0.00";
            document.getElementById('progress-fill').style.width = "100%";
            
            updateDisplay(); 
            
            playTone();
            playTone();
            
            if (testSets.current < testSets.total && (isManualFinish || currentLevelIndex >= pacerData.length)) {
                testSets.current++;
                resetTest(true); 
                document.getElementById('currentSetDisplay').innerText = `ชุดปัจจุบัน: ${testSets.current}`;
                document.getElementById('status-text').innerText = "พร้อมสำหรับชุดต่อไป!";
                setupRunnerButtons(); 
            } else {
                document.getElementById('status-text').innerText = "Test Completed! (ชุดปัจจุบันจบแล้ว)";
                
                document.getElementById('start-btn').innerText = 'START NEW TEST';
                document.getElementById('pause-btn').style.display = 'none';
                document.getElementById('next-set-btn').style.display = 'none';
                
                toggleButtonsState(); 
            }
        }

        function resetTest(keepScores = false) {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false;
            currentLevelIndex = 0;
            currentShuttleCount = 0;
            totalCumulativeLaps = 0; 
            startTime = 0; 
            
            toggleButtonsState();

            document.getElementById('level-display').innerText = "1";
            document.getElementById('shuttle-display').innerText = "1";
            document.getElementById('speed-display').innerText = "8.5";
            document.getElementById('cum-display').innerText = "0"; 
            document.getElementById('dist-display').innerText = "0";
            
            document.getElementById('score-text').innerText = "Level 1 - Lap 0 | รวม 0 รอบ | 0 ม."; 
            
            if (!keepScores) {
                testSets.data = {};
                testSets.current = 1;
                document.getElementById('totalSets').value = 1;
                testSets.total = 1;
                document.getElementById('currentSetDisplay').innerText = `ชุดปัจจุบัน: 1`;
            }

            renderRunnerScores(); 
            setupRunnerButtons(); 
            
            document.getElementById('countdown-display').innerText = "0.00";
            document.getElementById('total-time').innerText = "00:00";
            document.getElementById('status-text').innerText = "Ready to Start";
            document.getElementById('status-text').style.color = "var(--text-main)";
            document.getElementById('progress-fill').style.width = "0%";
            
            document.getElementById('start-btn').style.display = 'inline-block';
            document.getElementById('start-btn').innerText = 'START TEST';
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('next-set-btn').style.display = 'none';
            toggleButtonsState(); 
            
            closeModal(); 
        }
        
        // --- PDF Export Logic (UPDATED TO USE window.print()) ---
        function exportToPDF() {
             if (Object.keys(testSets.data).length === 0) {
                 showModal("ไม่พบข้อมูลคะแนนที่บันทึกไว้ กรุณาบันทึกผลการทดสอบก่อนส่งออกเป็น PDF", false);
                 return;
             }
             
             // Calls the native browser print/save dialog (like Ctrl+P)
             window.print();
             
             // Note: The custom filename logic is no longer possible with window.print(),
             // but the result will accurately reflect the screen content for easy saving.
        }

        // --- Data Definitions ---
        const pacerData = [
            { level: 1,  shuttles: 7,  seconds: 8.47, speed: 8.5 },
            { level: 2,  shuttles: 8,  seconds: 8.00, speed: 9.0 },
            { level: 3,  shuttles: 8,  seconds: 7.58, speed: 9.5 },
            { level: 4,  shuttles: 8,  seconds: 7.20, speed: 10.0 },
            { level: 5,  shuttles: 9,  seconds: 6.86, speed: 10.5 },
            { level: 6,  shuttles: 9,  seconds: 6.55, speed: 11.0 },
            { level: 7,  shuttles: 10, seconds: 6.26, speed: 11.5 },
            { level: 8,  shuttles: 10, seconds: 6.00, speed: 12.0 },
            { level: 9,  shuttles: 10, seconds: 5.76, speed: 12.5 },
            { level: 10, shuttles: 11, seconds: 5.54, speed: 13.0 },
            { level: 11, shuttles: 11, seconds: 5.33, speed: 13.5 },
            { level: 12, shuttles: 12, seconds: 5.14, speed: 14.0 },
            { level: 13, shuttles: 12, seconds: 4.97, speed: 14.5 },
            { level: 14, shuttles: 13, seconds: 4.80, speed: 15.0 },
            { level: 15, shuttles: 13, seconds: 4.65, speed: 15.5 },
            { level: 16, shuttles: 13, seconds: 4.50, speed: 16.0 },
            { level: 17, shuttles: 14, seconds: 4.36, speed: 16.5 },
            { level: 18, shuttles: 14, seconds: 4.24, speed: 17.0 },
            { level: 19, shuttles: 15, seconds: 4.11, speed: 17.5 },
            { level: 20, shuttles: 15, seconds: 4.00, speed: 18.0 },
            { level: 21, shuttles: 15, seconds: 3.89, speed: 18.5 }
        ];

        let cumulativeLapsTotalPacer = 0;
        pacerData.forEach(data => {
            cumulativeLapsTotalPacer += data.shuttles;
            data.cumulative = cumulativeLapsTotalPacer;
        });
        
        // Initial setup for the 10 buttons when the page loads
        window.onload = function() {
            setupRunnerButtons();
            document.getElementById('currentSetDisplay').innerText = `ชุดปัจจุบัน: ${testSets.current}`;
            document.getElementById('cum-display').innerText = "0";
            document.getElementById('dist-display').innerText = "0";
            document.getElementById('score-text').innerText = "Level 1 - Lap 0 | รวม 0 รอบ | 0 ม.";
            
            // Re-bind the external toggleFont function to the window
            window.toggleFont = toggleFont;
        };
    </script>
</body>
</html>
